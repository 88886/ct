
function selectOption(task_id){
    $("#modal-dialog-"+task_id).show();
    //var top =$("#selectbtn-"+task_id).offsetTop;
    //var divcss = {
    //top: top+'px',
    //};
    //$("#modal-dialog-"+task_id).css(divcss);
}
function closeOption(task_id){
    $("#modal-dialog-"+task_id).hide();
}
function runTask(task_action,task_id){
    var appUrl = "/cttask/task/task?task_action="+task_action+"&task_id="+task_id;
    $.post(appUrl,function(res){

        if(res.errno == 0){
            $("#modal-dialog-"+task_id).hide();
            $.apolloTip({
                refresh: true,
                tip: res.message,
                closeTime: 3500
            });
            return location.replace(location);
        }else{
            $("#modal-dialog-"+task_id).hide();
            var tpl;
            var data = res.data;
            tpl = '';
            tpl += '<div style="padding:5px 20px">';
            tpl += '<p>'+res.message+'</p>';

            $.each(data,function(index,value) {

                tpl += '<div class="form-group">';
                tpl += index+'&nbsp;&nbsp;&nbsp;&nbsp;';
                var c = "'"+value.code+"'";
                tpl += '<a class="btn btn-info" href="javascript:void(0);" onclick="retry('+c+')">重试</a>';
                tpl += '<input type="hidden" id="api_'+value.code+'" value="/cttask/task/retry">';
                tpl += '<input type="hidden" id="task_id_'+value.code+'" value="'+value.task.args.taskId+'">';
                tpl += '<input type="hidden" id="ip_'+value.code+'" value="'+index+'">';
                tpl += '<input type="hidden" id="action_'+value.code+'" value="'+value.action+'">';
                tpl += '<input type="hidden" id="function_'+value.code+'" value="'+value.task.function+'">';
                tpl += '<input type="hidden" id="rpc_action_'+value.code+'" value="'+value.task.action+'">';
                tpl += '</div>';

            });

            tpl += '</div>';

            return $(tpl).dialog({
                slow: 'slide',
                title: '任务错误',
                width: 800,
                height: 'auto',
                open: function (event, ui) {
                    $(this).bind('keypress', function (event) {
                        if (event.keyCode === $.ui.keyCode.ENTER) {
                            $('.ui-dialog-buttonpane button').first().click();
                            return false;
                        }
                    });
                },
                buttons: {
                    '取消': function () {
                        return $(this).dialog('close');
                    }
                }
            });
        }
    });
}

function retry(code){

    var api, tpl;
    api = $('#api_'+code).val();
    var task_id = $('#task_id_'+code).val();
    var ip = $('#ip_'+code).val();
    var action = $('#action_'+code).val();
    var funtion = $('#function_'+code).val();
    var rpc_action = $('#rpc_action_'+code).val();

    $.ajax({
        url: api,
        data: {
            "task_id": task_id,
            "ip": ip,
            "action": action,
            "funtion": funtion,
            "rpc_action": rpc_action,
        },
        dataType: "json",
        type: "POST",
        traditional: true,
        success: function (msg){
            if(msg.errno > 0){
                $.apolloTip({
                    refresh: false,
                    tip: msg.message,
                });
            }else {
                $.apolloTip({
                    refresh: false,
                    tip: msg.message,
                });
            }
        },
        error : function() {
            alert("网络异常");
        }
    });
}



(function() {
    $(function() {
        var operate;
        $('.delete').click(function() {
            return operate($(this), 'destroy');
        });


        $('.detail').click(function(){
            var param, tpl, title;
            param = $(this).data('param');

            title = '任务ID : '+param.task_id+' 机器详细';

            tpl = '';
            tpl += '<div style="padding:5px 20px">';
            tpl += '<form action="" method="">';
            tpl += '<br><p>'+param.host_name+'</p><br>';
            tpl += '</form>';
            tpl += '</div>';

            return $(tpl).dialog({
                slow: 'slide',
                title: title,
                width: 400,
                height: 500,
                open: function (event, ui) {
                    $(this).bind('keypress', function (event) {
                        if (event.keyCode === $.ui.keyCode.ENTER) {
                            $('.ui-dialog-buttonpane button').first().click();
                            return false;
                        }
                    });
                },
                buttons: {
                    '确认': function () {
                        return $(this).dialog('close');
                    },
                    '取消': function () {
                        return $(this).dialog('close');
                    }
                }
            });

        });

        $('.check').click(function(){
            var param, tpl, title, api;
            param = $(this).data('param');
            api = $(this).data('api');

            $.ajax({
                url: "/cttask/task/edit",
                data: {
                    "id": param.id,
                    "type" : "1",
                },
                dataType: "json",
                type: "get",
                success: function (msg){

                    var data = msg.data;

                    tpl = '';
                    tpl += '<div style="padding:5px 20px">';
                    tpl += '<form action="" method="">';

                    tpl += '<div class="form-group">';
                    tpl += '<label>任务名称:</label>';
                    tpl += '<input type="text" class="form-control" readonly="readonly" disabled value="'+data.task_info.task_name+'">';
                    tpl += '</div>';

                    tpl += '<div class="form-group">';
                    tpl += '<label>任务等级:</label>';
                    if(data.task_info.task_level == 1){
                        tpl += '<input type="text" class="form-control" readonly="readonly" disabled value="一级任务">';
                    }else if(data.task_info.task_level == 2){
                        tpl += '<input type="text" class="form-control" readonly="readonly" disabled value="二级任务">';
                    }else if(data.task_info.task_level == 3){
                        tpl += '<input type="text" class="form-control" readonly="readonly" disabled value="三级任务">';
                    }
                    tpl += '</div>';

                    tpl += '<div class="form-group">';
                    tpl += '<label>任务分组:</label>';
                    tpl += '<input type="text" class="form-control" readonly="readonly" disabled value="'+data.task_info.task_name+'">';
                    tpl += '</div>';

                    tpl += '<div class="form-group">';
                    tpl += '<label>报警邮箱:</label>';
                    tpl += '<br>RD邮箱:<input type="text" class="form-control" readonly="readonly" disabled value="'+data.task_info.alarm_email+'">';
                    tpl += 'Leader邮箱:<input type="text" class="form-control" readonly="readonly" disabled value="'+data.task_info.alarm_email_leader+'">';
                    tpl += 'OP邮箱:<input type="text" class="form-control" readonly="readonly" disabled value="'+data.task_info.alarm_email_op+'">';
                    tpl += '</div>';

                    tpl += '<div class="form-group">';
                    tpl += '<label>运行失败次数:</label>';
                    tpl += '<br>RD接收:<input type="text" class="form-control" readonly="readonly" disabled value="'+data.task_info.run_fail_num+'">';
                    tpl += 'Leader接收:<input type="text" class="form-control" readonly="readonly" disabled value="'+data.task_info.run_fail_num_leader+'">';
                    tpl += 'OP接收:<input type="text" class="form-control" readonly="readonly" disabled value="'+data.task_info.run_fail_num_op+'">';
                    tpl += '</div>';

                    tpl += '<div class="form-group">';
                    tpl += '<label>运行命令:</label>';
                    tpl += '<textarea rows="5" class="form-control" readonly="readonly" disabled cols="10">'+data.task_info.run_command+'</textarea>'
                    tpl += '</div>';

                    tpl += '<div class="form-group">';
                    tpl += '<label>调度时间:</label>';
                    tpl += '<input type="text" class="form-control" readonly="readonly" disabled value="'+data.task_info.ct1+data.task_info.ct2+data.task_info.ct3+data.task_info.ct4+data.task_info.ct5+'">';
                    tpl += '</div>';

                    tpl += '<div class="form-group">';
                    tpl += '<label>执行账号:</label>';
                    tpl += '<input type="text" class="form-control" readonly="readonly" disabled value="'+data.task_info.run_user+'">';
                    tpl += '</div>';

                    tpl += '<div class="form-group">';
                    tpl += '<label>服务节点:</label>';
                    tpl += '<input type="text" class="form-control" readonly="readonly" disabled value="'+data.task_info.service_node+'">';
                    tpl += '</div>';

                    tpl += '<div class="form-group">';
                    tpl += '<label>屏蔽机器:</label>';
                    tpl += '<input type="text" class="form-control" readonly="readonly" disabled value="'+data.shield_host_list+'">';
                    tpl += '</div>';

                    tpl += '<div class="form-group">';
                    tpl += '<label>运行成功判断条件:</label>';
                    tpl += '<input type="text" class="form-control" readonly="readonly" disabled value="'+data.task_info.run_condition+'">';
                    tpl += '</div>';

                    tpl += '<div class="form-group">';
                    tpl += '<label>等待超时时间:</label>';
                    tpl += '<input type="text" class="form-control" readonly="readonly" disabled value="'+data.task_info.wait_timeout_time+'">';
                    tpl += '</div>';

                    tpl += '<div class="form-group">';
                    tpl += '<label>运行超时时间:</label>';
                    tpl += '<input type="text" class="form-control" readonly="readonly" disabled value="'+data.task_info.run_timeout_time+'">';
                    tpl += '</div>';

                    tpl += '<div class="form-group">';
                    tpl += '<label>管理者:</label>';
                    tpl += '<input type="text" class="form-control" readonly="readonly" disabled value="'+data.task_info.manager+'">';
                    tpl += '</div>';


                    tpl += '</form>';
                    tpl += '</div>';

                    return $(tpl).dialog({
                        slow: 'slide',
                        title: '任务审核',
                        width: 700,
                        height: 700,
                        open: function (event, ui) {
                            $(this).bind('keypress', function (event) {
                                if (event.keyCode === $.ui.keyCode.ENTER) {
                                    $('.ui-dialog-buttonpane button').first().click();
                                    return false;
                                }
                            });
                        },
                        buttons: {
                            '通过': function () {
                                param['auth'] = 2;
                                return $.apolloAjaxTip({
                                    url: api,
                                    data: param,
                                    type: 'POST',
                                    closeTime: 1500
                                });
                            },
                            '不通过': function () {
                                param['auth'] = 3;
                                return $.apolloAjaxTip({
                                    url: api,
                                    data: param,
                                    type: 'POST',
                                    closeTime: 1500
                                });
                            },
                            '取消': function () {
                                return $(this).dialog('close');
                            }
                        }
                    });
                },
                error : function() {
                    alert("网络异常");
                }
            });
        });

        $('.operate').click(function(){
            var api, param, tpl, title;
            param = $(this).data('param');
            api = $(this).data('api');

            tpl = '';
            tpl += '<br><a href="" onclick="'+$(this).dialog('close')+'"></a><br>';
            tpl += '</div>';

            return $(tpl).dialog({
                slow: 'slide',
                title: title,
                width: 200,
                height: 240,
                open: function (event, ui) {
                    $(this).bind('keypress', function (event) {
                        if (event.keyCode === $.ui.keyCode.ENTER) {
                            $('.ui-dialog-buttonpane button').first().click();
                            return false;
                        }
                    });
                },
            });

        });

        return operate = function(opObj, method) {
            var param, tpl;
            param = opObj.data('param');
            tpl = '';
            tpl += '<div style="padding:5px 20px">';
            tpl += '<form method="POST" action="/cttask/task/delete">';
            tpl += '<div class="well">';
            tpl += '<p>确认 ' + opObj.text() + '? </p>';
            tpl += '</div>';
            tpl += '<input type="hidden" value="' + param.id + '" name="id"/>';
            tpl += '</form>';
            tpl += '</div>';
            return apollo.formDialog(tpl, {
                dialog: {
                    title: opObj.text()
                }
            });
        };


    });
}).call(this);

